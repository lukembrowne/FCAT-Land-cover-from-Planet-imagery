---
title: "FCAT Deforestation report 2019-2022"
author: Luke Browne
email: lukebrowne@fcat-ecuador.org
output: 
  pdf_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
date: "2023-04-05"
editor_options: 
  chunk_output_type: console
---

TODO

-   Be sure to mention that 2022_08 image has a bias to classify edges of clouds as non-forest - probably due to wispiness- how to avoid this?

-   Add in polygons for FCAT reserve, REMACH, Bilsa, and La Laguna to all the maps

```{=html}
<!-- -->
```
-   Why is deforestation %% from deforestation map so much higher than look at raw land cover %%?
    -   because of differences in cloud cover, etc?
-   Reformat to shown main takehome results first and then put methods at the end

\newpage

# Motivation

-   Our understanding of land use and land use change in the areas around the FCAT reserve has been limited by the lack of GIS data available, mainly due to near-persistant cloud cover
-   The availability of high resolution, frequent satellite imagery from Planet has finally enabled us to quantify and visualize land cover at scale
-   The goal of this analysis is to:
    -   Generate a high resolution (3m) land cover map of the FCAT reserve and surrounding areas
    -   Quantify deforestation rates and identify deforestation hotspots across time

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## Load libraries
  library(terra)
  library(tidyverse)
  library(xgboost)

## Load rasters
  ras2019 <- terra::rast("../../../Satellite imagery/Planet imagery/2019_09 - 4 band harmonized/20190903_merged_3B_AnalyticMS_SR_harmonized_clip.tif")
  ras2022 <- terra::rast("../../../Satellite imagery/Planet imagery/2022_08 - FCAT to Chachi - 4 band harmonized/20220815_merged_3B_AnalyticMS_SR_harmonized_clip.tif")
  
  run2019 <- "./output/2019_09_4band_FCATtoCachi - 2022_04_20/"
  cover2019 <- terra::rast(list.files(run2019, full.names = T)[1])
  mod2019 <-   list.files(run2019, full.names = T)[2]

  run2022 <- "./output/2022_08_4band_FCATtoCachi - 2022_04_19/"
  cover2022 <- terra::rast(list.files(run2022, full.names = T)[1])
  mod2022 <-   list.files(run2022, full.names = T)[2]

  
  # Extend 2019 raster so extents match
  # ras2019 <- extend(ras2019, ext(ras2022), fill = NA)

```

```{r plot_planet_images, echo=FALSE, fig.height=16, fig.width=8}
  par(mfrow = c(2,1))  
  terra::plotRGB(ras2019, r = 3, g = 2 , b = 1, stretch = "lin", mar = c(0,0,1,0), zlim = c(0, 2000), main = "2019")
  terra::plotRGB(ras2022, r = 3, g = 2 , b = 1, stretch = "lin", mar = c(0,0,1,0), zlim = c(0, 2000), main = "2022")
  par(mfrow = c(1,1)) 
##
```

## RGB Plots with training polygons

```{r RGB_Plots_with_training_polygons, echo=FALSE}

training_2019 <- terra::vect("./class_shapefiles/2019_09 classes.shp")
training_2022 <- terra::vect("./class_shapefiles/2022_08 classes.shp")

# Convert classes to colors
training_2019_colors <- factor(training_2019$class, labels = c("forestgreen", "yellow", "white", "grey80", "pink"))
training_2022_colors <- factor(training_2022$class, labels = c("forestgreen", "yellow", "white", "grey80", "pink"))

# Plot 2019 polygons
terra::plotRGB(ras2019, r = 3, g = 2 , b  = 1, stretch = "lin", mar = c(0,0,1,0), zlim = c(0, 2000), main = "2019 w/ training polygons")
polys(training_2019, col = training_2019_colors, alpha = 0.5)

# Plot 2022 polygons
terra::plotRGB(ras2022, r = 3, g = 2 , b  = 1, stretch = "lin", mar = c(0,0,1,0), zlim = c(0, 2000), main = "2022 w/ training polygons")
polys(training_2022, col = training_2022_colors, alpha = 0.5)

```

## Number and size of training polygons

```{r Number and size of training polygons, echo=FALSE}

  # Compare areas of each class
  training_count <- bind_cols(tibble(class = training_2019$class, 
                   area_2019_ha = expanse(training_2019)/10000) %>%
              group_by(class) %>%
              summarize(area_2019_ha = sum(area_2019_ha),
                        number_of_polygons_2019 = length(class)),
            tibble(class = training_2022$class, 
                   area_2022_ha = expanse(training_2022)/10000) %>%
              group_by(class) %>%
              summarize(area_2022_ha = sum(area_2022_ha),
                        number_of_polygons_2022 = length(class)) %>%
              select(-class)) %>%
       mutate(class = factor(class, labels = c("forest", "non-forest", "cloud", "shadow", "built environment"))) %>%
    mutate(area_2019_ha = round(area_2019_ha),
           area_2022_ha = round(area_2022_ha))

  # Print out table
  knitr::kable(training_count)
```

## Describe XGboost model

-   show variable importance and confusion matrix

```{r echo=FALSE}

# Load models
  load(mod2019)

  ## Look at variable importance
  importance_2019 <- xgb.importance(feature_names = predictors, model = boost)
  confusion_2019 <- confusion_mat
  # importance_2019
  

# Load models
  load(mod2022)

  ## Look at variable importance
  importance_2022 <- xgb.importance(feature_names = predictors, model = boost)
  confusion_2022 <- confusion_mat
  # importance_2022
  
# Plots
  par(mfrow = c(1, 2))
  xgb.plot.importance(importance_2019, main = "2019")
  xgb.plot.importance(importance_2022, main = "2022")

  par(mfrow = c(1,1))

```

## Confusion matrices

```{r echo=FALSE}

print(confusion_2019)

print(confusion_2022)

```

# Results - Land cover

## Land Cover - 2019

```{r plot land cover 2019, echo=FALSE, fig.height=8, fig.width=8}

  class_colors <- c("black", "forestgreen", "yellow", "white", "grey80")

# 2019 plot
  par(mfrow = c(1,2))
  terra::plotRGB(ras2019, r = 3, g = 2 , b = 1, stretch = "lin", mar = c(0,0,1,0), zlim = c(0, 2000), main = "2019")

  plot(cover2019, col = class_colors, 
       type = "classes", 
       levels = c("No data", "Forest", "Non-forest", "Cloud", "Shadow"),
       main = "2019")
  par(mfrow = c(1,1))

# 2022 plot 
  par(mfrow = c(1,2))
  terra::plotRGB(ras2022, r = 3, g = 2 , b = 1, stretch = "lin", mar = c(0,0,1,0), zlim = c(0, 2000), main = "2022")
  plot(cover2022, col = class_colors, 
       type = "classes", 
       levels = c("No data", "Forest", "Non-forest", "Cloud", "Shadow"),
       main = "2022")
  par(mfrow = c(1,1))


```

## Zoom in on focal region

```{r}

# Load in focal zone raster
focal_zone <- terra::vect("./class_shapefiles/Focal_zone_deforestation_report.shp")

focal_zone <- focal_zone[2] # Change up which focal zone to use here


# Crop rasters to focal zone
cover2019_focal <- crop(cover2019, focal_zone)
cover2022_focal <- crop(cover2022, focal_zone)


plot(cover2019_focal, col = class_colors[-1],
     type = "classes", 
     levels = c("Forest", "Non-forest", "Cloud", "Shadow"),
     main = "2019")

plot(cover2022_focal, col = class_colors[-1],
     type = "classes", 
     levels = c("Forest", "Non-forest", "Cloud", "Shadow"),
     main = "2022")

```

## Land cover stats

-   Is this a fair comparison if the areas without clouds are different in each image? Need to subset image to just areas without major clouds in both rasters?

```{r}

# Extract values from both rasters
cover_stats <- tibble(year = 2019,
                class = c(values(cover2019_focal)))

cover_stats <- bind_rows(cover_stats,
                          tibble(year = 2022,
                          class = c(values(cover2022_focal))))

# Overall
cover_stats_sum <- cover_stats %>%
  group_by(year, class) %>%
  tally() %>%
  mutate(area_ha = (n * 9)/10000) %>% # Cell size is 9m2
  mutate(area_perc = area_ha / sum(area_ha)) %>%
  mutate(class = factor(class, labels = c("Forest", "Non-forest", "Cloud", "Shadow")))

# Subset down to just forest and nonforest
cover_stats_sum_forest <- cover_stats_sum %>%
                          filter(class %in% c("Forest", "Non-forest")) %>%
                          mutate(area_perc = area_ha / sum(area_ha))

# Overall percentages
ggplot(cover_stats_sum, aes(x = class, y = area_perc, col = factor(year), group = factor(year), fill = factor(year))) + 
  geom_bar(stat = "identity", position = "dodge") + 
  ylab("Proportion of area") + 
  xlab("Class") +
  labs(fill = "Year", col = "Year") + 
  theme_bw(12)


# Just forest and non forest
ggplot(cover_stats_sum_forest, aes(x = class, y = area_perc, col = factor(year), group = factor(year), fill = factor(year))) + 
  geom_bar(stat = "identity", position = "dodge") + 
  ylab("Proportion of area") + 
  xlab("Class") +
  labs(fill = "Year", col = "Year") + 
  theme_bw(12)

cover_stats_sum_forest

```

# Results - Deforestation

-   Description of how deforestation was calculated

```{r}

defor <- terra::rast("./output/deforestation sieve 100 2019-2022 - 2023-04-20.tif")
defor_focal <- crop(defor, focal_zone)

plot(defor_focal, col = c("white", "red"),
     # ext = ext(focal_zone),
     type = "classes", 
     levels = c("No deforestation", "Deforestation"),
     main = "Deforestation")


```

## Calculate %% area deforestation

## Calculate total area deforested compared to focal zone

Compare estimated deforestation rates between GLADD alerts and FCAT alerts + Hansen

```{r}

# Load and process GLAD alerts and hansen forest loss data
  glad <- terra::rast("../../../Satellite imagery/GFW Deforestation alerts/10N_080W_cropped.tif")
  glad <- project(glad, focal_zone)
  glad_focal <- crop(glad, focal_zone)
  glad_focal[is.na(glad_focal)] <- 0 # Replace NA with 0 to indicate no alert
  
  hansen_loss <- terra::rast("../../../Satellite imagery/Hansen_ForestLossByYear/Hansen_GFC-2021-v1.9_lossyear_10N_080W_cropped_processed.tif")
  hansen_loss <- project(hansen_loss, focal_zone)
  hansen_loss_focal <- crop(hansen_loss, focal_zone)
  hansen_loss_focal[is.na(hansen_loss_focal)] <- 0 # Replace NA with 0 to indicate no alert
  

  # FCAT Extract values from raster
  defor_stats_fcat <- tibble(defor = c(values(defor_focal)))
  
  defor_stats_fcat_sum <- defor_stats_fcat %>%
                    summarize(defor_ha = (sum(defor) * 9) / 10000,
                              area_total_ha = (length(defor) * 9) / 10000) %>%
                    mutate(defor_perc = defor_ha / area_total_ha,
                           model = "FCAT")
  defor_stats_fcat_sum
  
  
  # GLADD
  defor_stats_glad <- tibble(defor = c(values(glad_focal)))
  
  defor_stats_glad_sum <- defor_stats_glad %>%
                    summarize(defor_ha = (sum(defor) * (11.1*11.1)) / 10000,
                              area_total_ha = (length(defor) * (11.1*11.1)) / 10000) %>%
                    mutate(defor_perc = defor_ha / area_total_ha,
                           model = "GLAD")
  defor_stats_glad_sum
  
  # Hansen
  defor_stats_hansen_loss <- tibble(defor = c(values(hansen_loss_focal)))
  
  defor_stats_hansen_loss_sum <- defor_stats_hansen_loss %>%
                    summarize(defor_ha = (sum(defor) * (11.1*11.1)) / 10000,
                              area_total_ha = (length(defor) * (11.1*11.1)) / 10000) %>%
                    mutate(defor_perc = defor_ha / area_total_ha,
                           model = "hansen_loss")
  defor_stats_hansen_loss_sum

# Bind all together
 defor_compare <- bind_rows(defor_stats_fcat_sum, 
                            defor_stats_glad_sum, 
                            defor_stats_hansen_loss_sum)
  defor_compare
```

## Deforestation over time

```{r}

defor_compare_yr <- defor_compare %>%
        mutate(defor_ha_yr = defor_ha / 3) # 3 years as rough interval - not fair to use for hansen data

# Starting point
year_range <- 2019:2050

defor_time <- expand_grid(year = year_range,
                     forest_ha = NA,
                     model = c("FCAT", "GLAD"))

defor_time$forest_ha[defor_time$year == 2019] <- cover_stats_sum_forest$area_ha[cover_stats_sum_forest$class == "Forest" & cover_stats_sum_forest$year == 2019]

for(year in (year_range + 1)){
  defor_time$forest_ha[defor_time$year == year & defor_time$model == "FCAT"] <- defor_time$forest_ha[defor_time$year == (year-1) & defor_time$model == "FCAT"] - defor_compare_yr$defor_ha_yr[defor_compare_yr$model == "FCAT"]
  defor_time$forest_ha[defor_time$year == year & defor_time$model == "GLAD"] <- defor_time$forest_ha[defor_time$year == (year-1) & defor_time$model == "GLAD"] - defor_compare_yr$defor_ha_yr[defor_compare_yr$model == "GLAD"]
}

ggplot(defor_time, aes(year, forest_ha, col = model)) + 
  geom_line() + 
  geom_hline(yintercept = 0) + 
  theme_bw(12)

## NEED TO INCLUDE REFORESTATION FOR NUMBERS TO MAKE SENSE?


```

## Hansen Forest Loss over time

```{r hansen loss over time}

hansen_loss <- terra::rast("../../../Satellite imagery/Hansen_ForestLossByYear/Hansen_GFC-2021-v1.9_lossyear_10N_080W.tif")
focal_zone2 <- project(focal_zone, hansen_loss)
hansen_loss_focal <- crop(hansen_loss, focal_zone2)

hansen_loss_sum <- tibble(value = c(values(hansen_loss_focal))) %>%
                    group_by(value) %>%
                    tally() %>%
                    mutate(defor_ha = (n * 769.3) / 10000, # Average cell size in m2 within Hansen focal zone %>%
                           area_total_ha = sum(defor_ha),
                           defor_perc = defor_ha / area_total_ha) %>%
                    filter(value != 0) %>%
                    mutate(year = value + 2000)

hansen_loss_sum

ggplot(hansen_loss_sum, aes(year, defor_ha)) + 
  geom_line() + 
  geom_point() +
  ylab("Deforestation (ha)") +
  theme_bw(15)

ggplot(hansen_loss_sum, aes(year, defor_perc)) + 
  geom_line() + 
  geom_point() +
  ylab("Deforestation (%)") +
  theme_bw(15)

```

## Compare deforestation within and outside of REMACH

```{r}

```

## Deforestation hotspots

```{r deforestation hotspots}

# Load in shapefile with rectangles of spots to highlight for deforestation
hotspots <- terra::vect("./reports/shapefiles/Deforestation hotspots.shp")

# Start loop
for(x in 1:length(hotspots)){
  
  par(mfrow = c(1, 3))
  
  # Basic RGB in 2019
  terra::plotRGB(ras2019, r = 3, g = 2 , b  = 1, 
                 stretch = "lin", mar = c(0,0,1,0), zlim = c(0, 2000),
                 ext = ext(hotspots[x]),
                 main = "2019")
  
  # RGB in 2019 with deforestation overlay
  terra::plotRGB(ras2019, r = 3, g = 2 , b  = 1, 
                 stretch = "lin", mar = c(0,0,1,0), zlim = c(0, 2000),
                 ext = ext(hotspots[x]),
                 main = "2019 w/ deforestation overlay")
  
    # FCAT Deforestation
    plot(defor_focal, col = c("white", "red"),
         ext = ext(hotspots[x]),
         type = "classes", 
         levels = c("No deforestation", "Deforestation"),
         main = "Deforestation", add = TRUE, alpha = 0.15)
    
    # Glad alerts
    plot(glad,
         col = "orange",
         ext = ext(hotspots[x]),
         type = "classes", 
         # levels = c("No deforestation", "Deforestation"),
         main = "Deforestation", add = TRUE, alpha = 0.15)
    
    #  # Hansen Forest Loss
    # plot(hansen_loss_focal,
    #      ext = ext(hotspots[x]),
    #      type = "classes", 
    #      # levels = c("No deforestation", "Deforestation"),
    #      main = "Deforestation", add = TRUE, alpha = 0.15)
    # 
  # 2022 raster
  terra::plotRGB(ras2022, r = 3, g = 2 , b  = 1, 
                 stretch = "lin", mar = c(0,0,1,0), zlim = c(0, 2000),
                 ext = ext(hotspots[x]),
                 main = "2022")
  par(mfrow = c(1, 1))
}

```

# Issues

-   Mainly where picture was cloudy in 2019 or 2022

```{r plotting issues}


# Load in shapefile with rectangles of spots to highlight for issues
issues <- terra::vect("./reports/shapefiles/Issues.shp")

# Start loop
for(x in 1:length(issues)){
  
  par(mfrow = c(1, 3))
  
  # Basic RGB in 2019
  terra::plotRGB(ras2019, r = 3, g = 2 , b  = 1, 
                 stretch = "lin", mar = c(0,0,1,0), zlim = c(0, 2000),
                 ext = ext(issues[x]),
                 main = "2019")
  
  # RGB in 2019 with deforestation overlay
  terra::plotRGB(ras2019, r = 3, g = 2 , b  = 1, 
                 stretch = "lin", mar = c(0,0,1,0), zlim = c(0, 2000),
                 ext = ext(issues[x]),
                 main = "2019 w/ deforestation overlay")
  
    # FCAT Deforestation
    plot(defor, col = c("white", "red"),
         ext = ext(issues[x]),
         type = "classes", 
         levels = c("No deforestation", "Deforestation"),
         main = "Deforestation", add = TRUE, alpha = 0.15)
    
    # Glad alerts
    plot(glad,
         col = "orange",
         ext = ext(issues[x]),
         type = "classes", 
         # levels = c("No deforestation", "Deforestation"),
         main = "Deforestation", add = TRUE, alpha = 0.15)
    # 
    #  # Hansen Forest Loss
    # plot(hansen_loss,
    #      ext = ext(issues[x]),
    #      type = "classes", 
    #      # levels = c("No deforestation", "Deforestation"),
    #      main = "Deforestation", add = TRUE, alpha = 0.15)
    # 
  # 2022 raster
  terra::plotRGB(ras2022, r = 3, g = 2 , b  = 1, 
                 stretch = "lin", mar = c(0,0,1,0), zlim = c(0, 2000),
                 ext = ext(issues[x]),
                 main = "2022")
  par(mfrow = c(1, 1))
}

```

## Calculate concordance between GLADD alerts and FCAT alerts

```{r}

# Crop, resample and fill in NAs for glad alerts
  glad_focal <- resample(glad_focal, defor_focal)
  glad_focal[is.na(glad_focal)] <- 0

plot(defor_focal, col = c("white", "red"))
plot(glad_focal, add = TRUE, alpha = .5, col = c("white", "orange"))

defor_compare <- defor_focal - glad_focal

plot(defor_compare)



defor_compare_sum <- tibble(value = c(values(defor_compare)))
defor_compare_sum <- defor_compare_sum %>%
                        mutate(type = case_when(
                                          value == 1   ~ "FCAT detected, GLAD not",
                                          value == 0 ~ "agreed",
                                          value == -1 ~ "GLAD detected, FCAT not",
                                  ))
defor_compare_sum <- defor_compare_sum %>%
                      group_by(type) %>%
                      tally() %>%
                      mutate(area_ha = (n * 9)/10000) %>% # Cell size is 9m2
                      mutate(area_perc = area_ha / sum(area_ha))

defor_compare_sum
```
